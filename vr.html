<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Splat - Meta Quest 3S</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }

        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            color: white;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 400px;
        }

        #info h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
        }

        #info p {
            margin: 10px 0;
            line-height: 1.5;
        }

        .status {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            margin: 10px 0;
        }

        .status.ok { background: #2ecc71; }
        .status.error { background: #e74c3c; }
        .status.warning { background: #f39c12; }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 999;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
        }

        button {
            padding: 20px 50px;
            font-size: 22px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        #debugInfo {
            position: fixed;
            bottom: 120px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: #0f0;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 998;
            display: none;
        }

        #debugInfo.show {
            display: block;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <h2>Cargando VR...</h2>
    </div>

    <div id="info">
        <h2>ü•Ω Gaussian Splat VR</h2>
        <p><strong>Estado:</strong> <span id="status" class="status warning">Verificando...</span></p>
        <p id="instructions">Iniciando sistema VR...</p>
        <button onclick="toggleDebug()" style="margin-top: 10px; padding: 5px 10px; font-size: 12px;">
            Mostrar Debug
        </button>
    </div>

    <div id="debugInfo"></div>

    <div class="btn-container">
        <button id="vrButton" disabled>Iniciando...</button>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@lumaai/luma-web": "https://unpkg.com/@lumaai/luma-web@0.2.0/dist/library/luma-web.module.js"
        }
    }
    </script>

    <script type="module">
        import { 
            WebGLRenderer, 
            PerspectiveCamera, 
            Scene,
            AmbientLight,
            DirectionalLight,
            Color
        } from 'three';
        import { LumaSplatsThree } from '@lumaai/luma-web';

        // ==================== DEBUG ====================
        const debugLogs = [];
        
        function log(msg, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = isError ? '‚ùå' : '‚úÖ';
            const fullMsg = `[${timestamp}] ${prefix} ${msg}`;
            
            console.log(fullMsg);
            debugLogs.push(fullMsg);
            
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = debugLogs.slice(-20).join('<br>');
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        window.toggleDebug = function() {
            document.getElementById('debugInfo').classList.toggle('show');
        };

        function updateStatus(type, text) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.textContent = text;
        }

        function updateInstructions(text) {
            document.getElementById('instructions').textContent = text;
        }

        log('Iniciando aplicaci√≥n VR');

        // ==================== CONFIGURACI√ìN B√ÅSICA ====================
        let scene, camera, renderer, splat;
        let isVRSupported = false;

        function init() {
            log('Inicializando Three.js');

            // Escena
            scene = new Scene();
            scene.background = new Color(0x000000);

            // C√°mara
            camera = new PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 1.6, 3);
            log('C√°mara creada en posici√≥n: 0, 1.6, 3');

            // Renderer
            try {
                renderer = new WebGLRenderer({ 
                    antialias: true,
                    alpha: false
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                document.body.appendChild(renderer.domElement);
                log('Renderer creado');

                // CR√çTICO: Habilitar XR
                renderer.xr.enabled = true;
                log('XR habilitado en renderer');

            } catch (error) {
                log('Error creando renderer: ' + error.message, true);
                updateStatus('error', 'Error de WebGL');
                return;
            }

            // Luces
            const ambientLight = new AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            const directionalLight = new DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);
            log('Iluminaci√≥n configurada');

            // Cargar Splat
            loadSplat();

            // Verificar VR
            checkVRSupport();

            // Iniciar render loop
            animate();

            // Resize
            window.addEventListener('resize', onResize);
        }

        // ==================== CARGAR SPLAT ====================
        function loadSplat() {
            log('Iniciando carga de Gaussian Splat');
            
            try {
                splat = new LumaSplatsThree({
                    source: 'https://lumalabs.ai/capture/d869f8b6-02be-49fe-a512-463ce9f26238',
                    enableThreeShaderIntegration: false
                });

                scene.add(splat);
                log('Splat a√±adido a la escena');

                splat.onLoad = () => {
                    log('Splat cargado exitosamente');
                    document.getElementById('loading').style.display = 'none';
                    updateInstructions('Splat cargado. Esperando verificaci√≥n VR...');
                };

                splat.onError = (error) => {
                    log('Error cargando splat: ' + error, true);
                    updateStatus('error', 'Error en Splat');
                    document.getElementById('loading').innerHTML = 
                        '<h2 style="color: #e74c3c;">Error al cargar Splat</h2>';
                };

            } catch (error) {
                log('Excepci√≥n al crear splat: ' + error.message, true);
            }
        }

        // ==================== VERIFICAR SOPORTE VR ====================
        async function checkVRSupport() {
            log('Verificando soporte VR...');
            
            const vrButton = document.getElementById('vrButton');

            // M√©todo 1: Verificar API b√°sica
            if (!('xr' in navigator)) {
                log('navigator.xr no disponible', true);
                updateStatus('error', 'WebXR no disponible');
                updateInstructions('‚ùå Tu navegador no soporta WebXR. Usa el Meta Browser.');
                vrButton.textContent = 'WebXR No Disponible';
                return;
            }

            log('navigator.xr existe');

            // M√©todo 2: Verificar sesi√≥n inmersiva
            try {
                log('Verificando soporte immersive-vr...');
                
                const supported = await navigator.xr.isSessionSupported('immersive-vr');
                
                log('Resultado isSessionSupported: ' + supported);

                if (supported) {
                    log('VR SOPORTADO en este dispositivo!');
                    isVRSupported = true;
                    updateStatus('ok', 'VR Disponible');
                    updateInstructions('‚úÖ VR listo. Presiona el bot√≥n para comenzar.');
                    
                    vrButton.disabled = false;
                    vrButton.textContent = 'ü•Ω ENTRAR A VR';
                    vrButton.onclick = enterVR;
                    
                } else {
                    log('VR NO soportado en este dispositivo', true);
                    updateStatus('error', 'VR no soportado');
                    updateInstructions('‚ùå Este dispositivo no soporta WebXR VR.');
                    vrButton.textContent = 'VR No Soportado';
                }

            } catch (error) {
                log('ERROR al verificar VR: ' + error.message, true);
                log('Error completo: ' + JSON.stringify(error), true);
                
                updateStatus('error', 'Error al verificar');
                updateInstructions('‚ùå Error: ' + error.message);
                
                // Intentar m√©todo alternativo
                tryAlternativeVRMethod();
            }
        }

        // ==================== M√âTODO ALTERNATIVO ====================
        function tryAlternativeVRMethod() {
            log('Intentando m√©todo alternativo de VR...');
            
            const vrButton = document.getElementById('vrButton');
            
            // Intentar crear sesi√≥n directamente
            vrButton.disabled = false;
            vrButton.textContent = 'ü•Ω INTENTAR VR';
            vrButton.onclick = async () => {
                log('Usuario hizo click en INTENTAR VR');
                
                try {
                    updateStatus('warning', 'Intentando...');
                    
                    const session = await navigator.xr.requestSession('immersive-vr', {
                        requiredFeatures: ['local-floor'],
                        optionalFeatures: ['bounded-floor', 'hand-tracking']
                    });
                    
                    log('¬°Sesi√≥n VR creada exitosamente!');
                    await renderer.xr.setSession(session);
                    
                    log('Sesi√≥n asignada al renderer');
                    updateStatus('ok', 'En VR');
                    vrButton.textContent = 'EN VR';
                    document.getElementById('info').style.display = 'none';
                    
                } catch (error) {
                    log('Error al crear sesi√≥n VR: ' + error.message, true);
                    updateStatus('error', 'Fall√≥');
                    alert('No se pudo iniciar VR:\n\n' + error.message + 
                          '\n\nAseg√∫rate de:\n1. Usar HTTPS\n2. Dar permisos al navegador\n3. Usar Meta Browser');
                }
            };
        }

        // ==================== ENTRAR A VR ====================
        async function enterVR() {
            log('Usuario presion√≥ ENTRAR A VR');
            
            if (!isVRSupported) {
                log('VR no soportado, abortando', true);
                return;
            }

            const vrButton = document.getElementById('vrButton');
            vrButton.disabled = true;
            vrButton.textContent = 'Iniciando VR...';
            updateStatus('warning', 'Iniciando...');

            try {
                log('Solicitando sesi√≥n VR...');
                
                const sessionInit = {
                    requiredFeatures: ['local-floor'],
                    optionalFeatures: ['bounded-floor', 'hand-tracking', 'layers']
                };

                const session = await navigator.xr.requestSession('immersive-vr', sessionInit);
                log('Sesi√≥n VR obtenida');

                await renderer.xr.setSession(session);
                log('Sesi√≥n asignada al renderer');

                updateStatus('ok', 'En VR');
                vrButton.textContent = 'EN VR';
                document.getElementById('info').style.display = 'none';

                // Eventos de sesi√≥n
                session.addEventListener('end', () => {
                    log('Sesi√≥n VR terminada');
                    vrButton.disabled = false;
                    vrButton.textContent = 'ü•Ω ENTRAR A VR';
                    updateStatus('ok', 'VR Disponible');
                    document.getElementById('info').style.display = 'block';
                });

            } catch (error) {
                log('ERROR al entrar a VR: ' + error.message, true);
                
                updateStatus('error', 'Error');
                vrButton.disabled = false;
                vrButton.textContent = 'ü•Ω REINTENTAR VR';
                
                alert('Error al iniciar VR:\n\n' + error.message + 
                      '\n\nPosibles soluciones:\n' +
                      '1. Acepta los permisos cuando los pida\n' +
                      '2. Aseg√∫rate de usar HTTPS\n' +
                      '3. Prueba cerrar y reabrir el navegador\n' +
                      '4. Usa el Meta Browser oficial');
            }
        }

        // ==================== ANIMACI√ìN ====================
        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render() {
            renderer.render(scene, camera);
        }

        // ==================== RESIZE ====================
        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            log('Ventana redimensionada');
        }

        // ==================== INICIAR TODO ====================
        try {
            init();
        } catch (error) {
            log('ERROR CR√çTICO en init: ' + error.message, true);
            updateStatus('error', 'Error cr√≠tico');
            alert('Error cr√≠tico:\n' + error.message);
        }

    </script>
</body>
</html>