<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Debug - Meta Quest 3S</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
            color: white;
        }

        /* Panel de informaci√≥n superior */
        #statusPanel {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.95);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #667eea;
            z-index: 1000;
            max-width: 500px;
        }

        #statusPanel h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .status-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .status-label {
            font-weight: bold;
            color: #667eea;
            display: inline-block;
            width: 150px;
        }

        .status-value {
            color: #fff;
        }

        .status-icon {
            font-size: 20px;
            margin-right: 10px;
        }

        /* Debug logs - ahora siempre visible */
        #debugLogs {
            position: fixed;
            bottom: 180px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.95);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 999;
            line-height: 1.6;
        }

        .log-entry {
            margin: 3px 0;
            padding: 3px 5px;
        }

        .log-success {
            color: #2ecc71;
        }

        .log-error {
            color: #e74c3c;
            font-weight: bold;
        }

        .log-warning {
            color: #f39c12;
        }

        .log-info {
            color: #3498db;
        }

        /* Botones inferiores */
        .button-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1001;
        }

        .btn {
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-size: 22px;
            padding: 25px;
        }

        .btn-primary:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-primary:not(:disabled):active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            font-size: 16px;
        }

        .btn-success {
            background: #2ecc71;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-warning {
            background: #f39c12;
        }

        /* Spinner de carga */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-content {
            text-align: center;
        }

        .big-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top: 6px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loading-overlay">
        <div class="loading-content">
            <div class="big-spinner"></div>
            <h2>Iniciando Sistema VR...</h2>
            <p style="margin-top: 10px; opacity: 0.7;">Cargando Gaussian Splat</p>
        </div>
    </div>

    <!-- Panel de estado -->
    <div id="statusPanel">
        <h2>ü•Ω Estado del Sistema VR</h2>
        
        <div class="status-item">
            <span class="status-label">WebXR API:</span>
            <span class="status-value" id="webxrStatus">
                <span class="spinner"></span>Verificando...
            </span>
        </div>

        <div class="status-item">
            <span class="status-label">Soporte VR:</span>
            <span class="status-value" id="vrStatus">
                <span class="spinner"></span>Verificando...
            </span>
        </div>

        <div class="status-item">
            <span class="status-label">Gaussian Splat:</span>
            <span class="status-value" id="splatStatus">
                <span class="spinner"></span>Cargando...
            </span>
        </div>

        <div class="status-item">
            <span class="status-label">Navegador:</span>
            <span class="status-value" id="browserInfo">Detectando...</span>
        </div>
    </div>

    <!-- Logs de debug - SIEMPRE VISIBLE -->
    <div id="debugLogs">
        <div style="color: #4ecdc4; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
            üìã DEBUG LOG (√∫ltimas 15 l√≠neas)
        </div>
        <div id="logContent"></div>
    </div>

    <!-- Botones -->
    <div class="button-container">
        <!-- Bot√≥n principal VR -->
        <button id="vrButton" class="btn btn-primary" disabled>
            <span class="spinner"></span>Iniciando...
        </button>

        <!-- Botones de acci√≥n secundarios -->
        <div style="display: flex; gap: 10px;">
            <button id="reloadBtn" class="btn btn-secondary" onclick="location.reload()" style="flex: 1;">
                üîÑ Recargar P√°gina
            </button>
            <button id="copyLogsBtn" class="btn btn-secondary" onclick="copyLogs()" style="flex: 1;">
                üìã Copiar Logs
            </button>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@lumaai/luma-web": "https://unpkg.com/@lumaai/luma-web@0.2.0/dist/library/luma-web.module.js"
        }
    }
    </script>

    <script type="module">
        import { 
            WebGLRenderer, 
            PerspectiveCamera, 
            Scene,
            AmbientLight,
            DirectionalLight,
            Color
        } from 'three';
        import { LumaSplatsThree } from '@lumaai/luma-web';

        // ==================== SISTEMA DE LOGS ====================
        const logs = [];
        const MAX_LOGS = 15;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            const logEntry = {
                time: timestamp,
                message: message,
                type: type,
                icon: icons[type] || '‚ÑπÔ∏è'
            };

            logs.push(logEntry);
            console.log(`[${timestamp}] ${logEntry.icon} ${message}`);

            // Mantener solo las √∫ltimas MAX_LOGS entradas
            if (logs.length > MAX_LOGS) {
                logs.shift();
            }

            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContent = document.getElementById('logContent');
            logContent.innerHTML = logs.map(log => 
                `<div class="log-entry log-${log.type}">[${log.time}] ${log.icon} ${log.message}</div>`
            ).join('');
            logContent.scrollTop = logContent.scrollHeight;
        }

        function updateStatus(elementId, text, isSuccess = null) {
            const element = document.getElementById(elementId);
            if (isSuccess === true) {
                element.innerHTML = `<span class="status-icon">‚úÖ</span>${text}`;
                element.style.color = '#2ecc71';
            } else if (isSuccess === false) {
                element.innerHTML = `<span class="status-icon">‚ùå</span>${text}`;
                element.style.color = '#e74c3c';
            } else {
                element.innerHTML = `<span class="status-icon">‚ö†Ô∏è</span>${text}`;
                element.style.color = '#f39c12';
            }
        }

        // Funci√≥n para copiar logs
        window.copyLogs = function() {
            const logText = logs.map(log => `[${log.time}] ${log.icon} ${log.message}`).join('\n');
            navigator.clipboard.writeText(logText).then(() => {
                alert('Logs copiados al portapapeles');
            }).catch(() => {
                alert('No se pudieron copiar los logs');
            });
        };

        // ==================== VARIABLES GLOBALES ====================
        let scene, camera, renderer, splat;
        let vrButton = document.getElementById('vrButton');

        // ==================== DETECTAR NAVEGADOR ====================
        function detectBrowser() {
            const ua = navigator.userAgent;
            let browser = 'Desconocido';
            
            if (ua.includes('OculusBrowser')) browser = 'Meta Browser (Oculus) ‚úÖ';
            else if (ua.includes('Quest')) browser = 'Quest Browser ‚úÖ';
            else if (ua.includes('Chrome')) browser = 'Chrome ‚ö†Ô∏è';
            else if (ua.includes('Firefox')) browser = 'Firefox ‚ö†Ô∏è';
            else if (ua.includes('Safari')) browser = 'Safari ‚ùå';

            document.getElementById('browserInfo').textContent = browser;
            addLog(`Navegador detectado: ${browser}`, 'info');

            if (!ua.includes('Quest') && !ua.includes('Oculus')) {
                addLog('ADVERTENCIA: No parece ser Meta Browser oficial', 'warning');
            }
        }

        // ==================== INICIALIZACI√ìN ====================
        async function init() {
            addLog('üöÄ Iniciando aplicaci√≥n VR', 'info');
            detectBrowser();

            // Verificar HTTPS
            if (location.protocol !== 'https:') {
                addLog('ERROR: La p√°gina NO est√° en HTTPS', 'error');
                updateStatus('webxrStatus', 'Requiere HTTPS', false);
                vrButton.textContent = '‚ùå ERROR: Requiere HTTPS';
                vrButton.classList.remove('btn-primary');
                vrButton.classList.add('btn-danger');
                return;
            } else {
                addLog('‚úì P√°gina servida por HTTPS', 'success');
            }

            // Crear escena
            try {
                addLog('Creando escena Three.js', 'info');
                scene = new Scene();
                scene.background = new Color(0x000000);
                addLog('‚úì Escena creada', 'success');
            } catch (error) {
                addLog(`ERROR creando escena: ${error.message}`, 'error');
                return;
            }

            // Crear c√°mara
            try {
                camera = new PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 1.6, 3);
                addLog('‚úì C√°mara configurada', 'success');
            } catch (error) {
                addLog(`ERROR creando c√°mara: ${error.message}`, 'error');
                return;
            }

            // Crear renderer
            try {
                addLog('Creando WebGL Renderer', 'info');
                renderer = new WebGLRenderer({ antialias: true, alpha: false });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                document.body.appendChild(renderer.domElement);
                addLog('‚úì Renderer creado', 'success');

                // CR√çTICO: Habilitar XR
                renderer.xr.enabled = true;
                addLog('‚úì WebXR habilitado en renderer', 'success');

            } catch (error) {
                addLog(`ERROR creando renderer: ${error.message}`, 'error');
                updateStatus('webxrStatus', 'Error WebGL', false);
                return;
            }

            // Iluminaci√≥n
            scene.add(new AmbientLight(0xffffff, 0.8));
            scene.add(new DirectionalLight(0xffffff, 0.5));
            addLog('‚úì Iluminaci√≥n configurada', 'success');

            // Cargar splat
            loadSplat();

            // Verificar VR
            await checkWebXR();

            // Iniciar animaci√≥n
            renderer.setAnimationLoop(render);
            addLog('‚úì Loop de renderizado iniciado', 'success');

            // Resize handler
            window.addEventListener('resize', onResize);
        }

        // ==================== CARGAR SPLAT ====================
        function loadSplat() {
            addLog('üì• Iniciando carga de Gaussian Splat', 'info');
            
            try {
                splat = new LumaSplatsThree({
                    source: 'https://lumalabs.ai/capture/d869f8b6-02be-49fe-a512-463ce9f26238',
                    enableThreeShaderIntegration: false
                });

                scene.add(splat);
                addLog('‚úì Splat a√±adido a escena', 'success');

                splat.onLoad = () => {
                    addLog('‚úì ¬°Splat cargado completamente!', 'success');
                    updateStatus('splatStatus', 'Cargado', true);
                    document.getElementById('loading-overlay').style.display = 'none';
                };

                splat.onError = (error) => {
                    addLog(`ERROR cargando splat: ${error}`, 'error');
                    updateStatus('splatStatus', 'Error al cargar', false);
                    document.getElementById('loading-overlay').style.display = 'none';
                };

            } catch (error) {
                addLog(`ERROR al crear splat: ${error.message}`, 'error');
                updateStatus('splatStatus', 'Error', false);
            }
        }

        // ==================== VERIFICAR WEBXR ====================
        async function checkWebXR() {
            addLog('üîç Verificando WebXR API', 'info');

            // Paso 1: ¬øExiste navigator.xr?
            if (!('xr' in navigator)) {
                addLog('ERROR: navigator.xr NO existe', 'error');
                updateStatus('webxrStatus', 'No disponible', false);
                updateStatus('vrStatus', 'No soportado', false);
                
                vrButton.textContent = '‚ùå WebXR No Disponible';
                vrButton.classList.remove('btn-primary');
                vrButton.classList.add('btn-danger');
                
                addLog('SOLUCI√ìN: Usa Meta Browser oficial del Quest', 'warning');
                return;
            }

            addLog('‚úì navigator.xr existe', 'success');
            updateStatus('webxrStatus', 'Disponible', true);

            // Paso 2: ¬øSoporta immersive-vr?
            try {
                addLog('Verificando soporte immersive-vr...', 'info');
                
                const supported = await navigator.xr.isSessionSupported('immersive-vr');
                
                addLog(`Resultado: ${supported}`, supported ? 'success' : 'error');

                if (supported) {
                    addLog('‚úì ¬°VR SOPORTADO!', 'success');
                    updateStatus('vrStatus', 'Soportado', true);
                    
                    vrButton.disabled = false;
                    vrButton.innerHTML = 'ü•Ω ENTRAR A VR';
                    vrButton.classList.add('btn-success');
                    vrButton.onclick = enterVR;

                } else {
                    addLog('ERROR: VR no soportado en este dispositivo', 'error');
                    updateStatus('vrStatus', 'No soportado', false);
                    
                    vrButton.textContent = '‚ùå VR No Soportado';
                    vrButton.classList.remove('btn-primary');
                    vrButton.classList.add('btn-danger');
                }

            } catch (error) {
                addLog(`ERROR verificando VR: ${error.message}`, 'error');
                addLog(`Tipo de error: ${error.name}`, 'error');
                updateStatus('vrStatus', 'Error al verificar', false);
                
                vrButton.textContent = '‚ùå Error al Verificar VR';
                vrButton.classList.remove('btn-primary');
                vrButton.classList.add('btn-danger');

                // Intentar m√©todo alternativo
                addLog('Probando m√©todo alternativo...', 'warning');
                tryDirectVR();
            }
        }

        // ==================== M√âTODO ALTERNATIVO ====================
        function tryDirectVR() {
            addLog('üîÑ Intentando activaci√≥n directa de VR', 'warning');
            
            vrButton.disabled = false;
            vrButton.textContent = '‚ö†Ô∏è FORZAR INTENTO VR';
            vrButton.classList.remove('btn-primary');
            vrButton.classList.add('btn-warning');
            
            vrButton.onclick = async () => {
                addLog('Usuario hizo click en FORZAR INTENTO', 'info');
                
                try {
                    addLog('Solicitando sesi√≥n VR directamente...', 'info');
                    
                    const session = await navigator.xr.requestSession('immersive-vr', {
                        requiredFeatures: ['local-floor'],
                        optionalFeatures: ['bounded-floor']
                    });
                    
                    addLog('‚úì ¬°Sesi√≥n VR obtenida!', 'success');
                    
                    await renderer.xr.setSession(session);
                    addLog('‚úì Sesi√≥n asignada al renderer', 'success');
                    
                    vrButton.textContent = '‚úÖ EN VR';
                    vrButton.classList.remove('btn-warning');
                    vrButton.classList.add('btn-success');
                    
                    document.getElementById('statusPanel').style.display = 'none';
                    
                } catch (error) {
                    addLog(`ERROR al forzar VR: ${error.message}`, 'error');
                    addLog(`C√≥digo de error: ${error.name}`, 'error');
                    
                    alert(`No se pudo iniciar VR:\n\n${error.message}\n\nRevisa los logs y:\n1. Aseg√∫rate de estar en HTTPS\n2. Usa Meta Browser oficial\n3. Da permisos cuando los pida`);
                }
            };
        }

        // ==================== ENTRAR A VR ====================
        async function enterVR() {
            addLog('üëÜ Usuario presion√≥ ENTRAR A VR', 'info');
            
            vrButton.disabled = true;
            vrButton.innerHTML = '<span class="spinner"></span>Iniciando VR...';

            try {
                addLog('Solicitando sesi√≥n immersive-vr...', 'info');
                
                const session = await navigator.xr.requestSession('immersive-vr', {
                    requiredFeatures: ['local-floor'],
                    optionalFeatures: ['bounded-floor', 'hand-tracking']
                });

                addLog('‚úì Sesi√≥n VR obtenida', 'success');

                await renderer.xr.setSession(session);
                addLog('‚úì Sesi√≥n asignada correctamente', 'success');

                vrButton.textContent = '‚úÖ EN VR';
                vrButton.classList.remove('btn-success');
                vrButton.classList.add('btn-primary');
                document.getElementById('statusPanel').style.display = 'none';
                document.getElementById('debugLogs').style.display = 'none';

                session.addEventListener('end', () => {
                    addLog('Sesi√≥n VR terminada por el usuario', 'info');
                    vrButton.disabled = false;
                    vrButton.textContent = 'ü•Ω ENTRAR A VR';
                    document.getElementById('statusPanel').style.display = 'block';
                    document.getElementById('debugLogs').style.display = 'block';
                });

            } catch (error) {
                addLog(`ERROR al entrar a VR: ${error.message}`, 'error');
                addLog(`Nombre del error: ${error.name}`, 'error');
                
                vrButton.disabled = false;
                vrButton.textContent = 'ü•Ω REINTENTAR VR';
                
                alert(`Error:\n${error.message}\n\n` +
                      `Tipo: ${error.name}\n\n` +
                      `Soluciones:\n` +
                      `1. Acepta los permisos\n` +
                      `2. Verifica HTTPS en la URL\n` +
                      `3. Usa Meta Browser\n` +
                      `4. Reinicia el navegador`);
            }
        }

        // ==================== RENDER ====================
        function render() {
            renderer.render(scene, camera);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ==================== INICIAR ====================
        try {
            init();
        } catch (error) {
            addLog(`ERROR CR√çTICO: ${error.message}`, 'error');
            alert('Error cr√≠tico al iniciar. Revisa los logs.');
        }
    </script>
</body>
</html>