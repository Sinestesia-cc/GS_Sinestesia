<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaussian Splat - Demo Completa [FIXED]</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 15px;
            z-index: 100;
            backdrop-filter: blur(10px);
            max-width: 300px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        #info h2 {
            margin: 0 0 15px 0;
            font-size: 24px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #info p {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .key {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 5px;
            font-weight: bold;
            margin: 0 3px;
        }

        #stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 15px;
            font-family: monospace;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 90%;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        #minimap {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.3);
        }

        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            display: none;
            z-index: 200;
        }
    </style>
</head>
<body>
    <div id="info">
        <h2>üéÆ Controles</h2>
        <p><span class="key">W A S D</span> - Mover</p>
        <p><span class="key">Q E</span> - Subir/Bajar</p>
        <p><span class="key">Shift</span> - Correr (2x)</p>
        <p><span class="key">Mouse Drag</span> - Rotar</p>
        <p><span class="key">Scroll</span> - Zoom</p>
        <p><span class="key">T</span> - Texto 3D</p>
        <p><span class="key">M</span> - A√±adir cubo</p>
    </div>

    <div id="stats">
        <div>FPS: <span id="fps">60</span></div>
        <div>Pos: <span id="position">0, 0, 0</span></div>
        <div>Objetos: <span id="objects">0</span></div>
        <div>Vel: <span id="speed">Normal</span></div>
    </div>

    <div id="controls">
        <button class="btn" onclick="toggleTexto3D()">üìù Texto 3D</button>
        <button class="btn" onclick="agregarModelo3D()">üé≤ Cubo</button>
        <button class="btn" onclick="agregarEsfera()">‚öΩ Esfera</button>
        <button class="btn" onclick="toggleLuces()">üí° Luces</button>
        <button class="btn" onclick="resetCamera()">üé• Reset</button>
    </div>

    <canvas id="minimap"></canvas>
    <div id="message"></div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/",
            "@lumaai/luma-web": "https://unpkg.com/@lumaai/luma-web@0.2.0/dist/library/luma-web.module.js"
        }
    }
    </script>

    <script type="module">
        import { 
            WebGLRenderer, 
            PerspectiveCamera, 
            Scene,
            BoxGeometry,
            SphereGeometry,
            MeshStandardMaterial,
            Mesh,
            DirectionalLight,
            AmbientLight,
            PointLight,
            HemisphereLight,
            Vector3,
            Euler
        } from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { LumaSplatsThree } from '@lumaai/luma-web';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';

        // ==================== CONFIGURACI√ìN INICIAL ====================
        let canvas = document.createElement('canvas');
        document.body.appendChild(canvas);
        
        let renderer = new WebGLRenderer({ 
            canvas: canvas, 
            antialias: true,
            alpha: true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;

        let scene = new Scene();
        
        let camera = new PerspectiveCamera(
            75, 
            window.innerWidth / window.innerHeight, 
            0.1, 
            1000
        );
        camera.position.set(0, 1.6, 5);

        // ==================== CONTROLES ORBIT ====================
        let controls = new OrbitControls(camera, canvas);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI;
        // üîë CLAVE: Solo permitir rotaci√≥n, NO movimiento
        controls.enablePan = false; // Deshabilitar paneo

        // ==================== SISTEMA DE MOVIMIENTO INDEPENDIENTE ====================
        let moveState = {
            forward: false,
            backward: false,
            left: false,
            right: false,
            up: false,
            down: false,
            running: false
        };

        const WALK_SPEED = 15.0;
        const RUN_SPEED = 30.0;
        const FLY_SPEED = 10.0;

        // ==================== TECLADO ====================
        document.addEventListener('keydown', (event) => {
            switch (event.code) {
                case 'KeyW': moveState.forward = true; break;
                case 'KeyS': moveState.backward = true; break;
                case 'KeyA': moveState.left = true; break;
                case 'KeyD': moveState.right = true; break;
                case 'KeyQ': moveState.up = true; break;
                case 'KeyE': moveState.down = true; break;
                case 'ShiftLeft': 
                    moveState.running = true;
                    document.getElementById('speed').textContent = 'Corriendo üèÉ';
                    break;
                case 'KeyT': toggleTexto3D(); break;
                case 'KeyM': agregarModelo3D(); break;
            }
        });

        document.addEventListener('keyup', (event) => {
            switch (event.code) {
                case 'KeyW': moveState.forward = false; break;
                case 'KeyS': moveState.backward = false; break;
                case 'KeyA': moveState.left = false; break;
                case 'KeyD': moveState.right = false; break;
                case 'KeyQ': moveState.up = false; break;
                case 'KeyE': moveState.down = false; break;
                case 'ShiftLeft': 
                    moveState.running = false;
                    document.getElementById('speed').textContent = 'Normal üö∂';
                    break;
            }
        });

        // ==================== FUNCI√ìN DE MOVIMIENTO WASD ====================
        function updateMovement(delta) {
            // Si no hay teclas presionadas, no hacer nada
            const isMoving = moveState.forward || moveState.backward || 
                           moveState.left || moveState.right || 
                           moveState.up || moveState.down;
            
            if (!isMoving) return;

            // Velocidad base
            const speed = moveState.running ? RUN_SPEED : WALK_SPEED;
            const moveDistance = speed * delta;
            const flyDistance = FLY_SPEED * delta;

            // üîë OBTENER DIRECCI√ìN DE LA C√ÅMARA (a d√≥nde mira)
            const cameraDirection = new Vector3();
            camera.getWorldDirection(cameraDirection);
            
            // Proyectar al plano horizontal (ignorar Y)
            cameraDirection.y = 0;
            cameraDirection.normalize();

            // Vector derecho (perpendicular a la direcci√≥n)
            const rightVector = new Vector3();
            rightVector.crossVectors(camera.up, cameraDirection);
            rightVector.normalize();

            // üîß MOVIMIENTO CORREGIDO (direcciones correctas)
            if (moveState.forward) {
                camera.position.addScaledVector(cameraDirection, moveDistance);
                controls.target.addScaledVector(cameraDirection, moveDistance);
            }
            if (moveState.backward) {
                camera.position.addScaledVector(cameraDirection, -moveDistance);
                controls.target.addScaledVector(cameraDirection, -moveDistance);
            }
            if (moveState.right) {
                camera.position.addScaledVector(rightVector, moveDistance);
                controls.target.addScaledVector(rightVector, moveDistance);
            }
            if (moveState.left) {
                camera.position.addScaledVector(rightVector, -moveDistance);
                controls.target.addScaledVector(rightVector, -moveDistance);
            }
            if (moveState.up) {
                camera.position.y += flyDistance;
                controls.target.y += flyDistance;
            }
            if (moveState.down) {
                camera.position.y -= flyDistance;
                controls.target.y -= flyDistance;
            }
        }

        // ==================== ILUMINACI√ìN ====================
        let ambientLight = new AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        let directionalLight = new DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 20, 10);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        let hemisphereLight = new HemisphereLight(0x87ceeb, 0x545454, 0.3);
        scene.add(hemisphereLight);

        // Luces de colores
        let pointLights = [];
        let lightColors = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00];
        let lightsEnabled = false;

        function createColorLights() {
            for (let i = 0; i < 4; i++) {
                let light = new PointLight(lightColors[i], 1, 50);
                let angle = (i / 4) * Math.PI * 2;
                light.position.set(
                    Math.cos(angle) * 8,
                    3,
                    Math.sin(angle) * 8
                );
                pointLights.push(light);
            }
        }
        createColorLights();

        // ==================== GAUSSIAN SPLAT ====================
        let splat = new LumaSplatsThree({
            source: 'https://lumalabs.ai/capture/d869f8b6-02be-49fe-a512-463ce9f26238',
            enableThreeShaderIntegration: false
        });
        scene.add(splat);

        splat.onLoad = () => {
            mostrarMensaje('¬°Splat cargado! üéâ');
        };

        // ==================== TEXTO 3D ====================
        let texto3D = null;
        let texto3DVisible = false;

        function crearTexto3D() {
            const loader = new FontLoader();
            loader.load('https://threejs.org/examples/fonts/helvetiker_bold.typeface.json', (font) => {
                const textGeometry = new TextGeometry('Hola, Sinestesia!', {
                    font: font,
                    size: 0.5,
                    height: 0.1,
                    curveSegments: 12,
                    bevelEnabled: true,
                    bevelThickness: 0.02,
                    bevelSize: 0.02,
                    bevelSegments: 5
                });

                textGeometry.center();

                const materials = [
                    new MeshStandardMaterial({ color: 0xff6b6b }),
                    new MeshStandardMaterial({ color: 0x4ecdc4 })
                ];

                texto3D = new Mesh(textGeometry, materials);
                texto3D.position.set(20, 60, -0);
                texto3D.castShadow = true;
                texto3D.visible = false;
                scene.add(texto3D);
            });
        }

        crearTexto3D();

        // ==================== MODELOS 3D ====================
        let modelos3D = [];

        function agregarModelo3D() {
            const geometry = new BoxGeometry(0.5, 0.5, 0.5);
            const material = new MeshStandardMaterial({ 
                color: Math.random() * 0xffffff,
                metalness: 0.3,
                roughness: 0.4
            });
            const cube = new Mesh(geometry, material);
            
            const distance = 3;
            const angle = Math.random() * Math.PI * 2;
            cube.position.set(
                camera.position.x + Math.cos(angle) * distance,
                camera.position.y + (Math.random() - 0.5) * 2,
                camera.position.z + Math.sin(angle) * distance
            );
            
            cube.castShadow = true;
            cube.receiveShadow = true;
            
            modelos3D.push(cube);
            scene.add(cube);
            
            actualizarStats();
            mostrarMensaje('Cubo a√±adido! üé≤');
        }

        function agregarEsfera() {
            const geometry = new SphereGeometry(0.3, 32, 32);
            const material = new MeshStandardMaterial({ 
                color: Math.random() * 0xffffff,
                metalness: 0.8,
                roughness: 0.2
            });
            const sphere = new Mesh(geometry, material);
            
            const distance = 3;
            const angle = Math.random() * Math.PI * 2;
            sphere.position.set(
                camera.position.x + Math.cos(angle) * distance,
                camera.position.y + (Math.random() - 0.5) * 2,
                camera.position.z + Math.sin(angle) * distance
            );
            
            sphere.castShadow = true;
            sphere.receiveShadow = true;
            
            modelos3D.push(sphere);
            scene.add(sphere);
            
            actualizarStats();
            mostrarMensaje('Esfera a√±adida! ‚öΩ');
        }

        // ==================== FUNCIONES UI ====================
        window.toggleTexto3D = function() {
            if (texto3D) {
                texto3DVisible = !texto3DVisible;
                texto3D.visible = texto3DVisible;
                mostrarMensaje(texto3DVisible ? 'Texto activado üìù' : 'Texto desactivado');
            }
        };

        window.agregarModelo3D = agregarModelo3D;
        window.agregarEsfera = agregarEsfera;

        window.toggleLuces = function() {
            lightsEnabled = !lightsEnabled;
            pointLights.forEach(light => {
                if (lightsEnabled && !light.parent) {
                    scene.add(light);
                } else if (!lightsEnabled && light.parent) {
                    scene.remove(light);
                }
            });
            mostrarMensaje(lightsEnabled ? 'Luces de colores ON üí°' : 'Luces de colores OFF');
        };

        window.resetCamera = function() {
            camera.position.set(0, 1.6, 5);
            controls.target.set(0, 0, 0);
            controls.update();
            mostrarMensaje('C√°mara reseteada üé•');
        };

        function mostrarMensaje(texto) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = texto;
            msgDiv.style.display = 'block';
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 2000);
        }

        // ==================== MINIMAP ====================
        let minimapRenderer = new WebGLRenderer({ 
            canvas: document.getElementById('minimap'),
            alpha: true
        });
        minimapRenderer.setSize(150, 150);
        
        let minimapCamera = new PerspectiveCamera(60, 1, 0.1, 100);
        minimapCamera.position.set(0, 20, 0);
        minimapCamera.lookAt(0, 0, 0);

        // ==================== ESTAD√çSTICAS ====================
        let frameCount = 0;
        let lastTime = performance.now();
        let prevTime = performance.now();

        function actualizarStats() {
            frameCount++;
            const currentTime = performance.now();
            if (currentTime >= lastTime + 1000) {
                document.getElementById('fps').textContent = frameCount;
                frameCount = 0;
                lastTime = currentTime;
            }

            document.getElementById('position').textContent = 
                `${camera.position.x.toFixed(1)}, ${camera.position.y.toFixed(1)}, ${camera.position.z.toFixed(1)}`;

            document.getElementById('objects').textContent = scene.children.length;
        }

        // ==================== ANIMACI√ìN - COMPLETAMENTE REESCRITA ====================
        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now();
            const delta = (time - prevTime) / 1000;
            prevTime = time;

            // 1Ô∏è‚É£ PRIMERO: Actualizar movimiento WASD
            updateMovement(delta);

            // 2Ô∏è‚É£ SEGUNDO: Animar objetos 3D
            modelos3D.forEach((modelo, index) => {
                modelo.rotation.x += 0.01;
                modelo.rotation.y += 0.01;
                modelo.position.y += Math.sin(time * 0.001 + index) * 0.001;
            });

            // Animar texto 3D
            if (texto3D && texto3DVisible) {
                texto3D.rotation.y += 0.0;
                texto3D.position.y = 2 + Math.sin(time * 0.001) * 0.2;
            }

            // Animar luces de colores
            if (lightsEnabled) {
                pointLights.forEach((light, index) => {
                    const angle = (time * 0.001) + (index / pointLights.length) * Math.PI * 2;
                    light.position.x = Math.cos(angle) * 8;
                    light.position.z = Math.sin(angle) * 8;
                    light.position.y = 3 + Math.sin(time * 0.002 + index) * 2;
                });
            }

            // 3Ô∏è‚É£ TERCERO: Actualizar OrbitControls (solo para rotaci√≥n)
            controls.update();

            // 4Ô∏è‚É£ CUARTO: Renderizar
            renderer.render(scene, camera);

            // Minimap
            minimapCamera.position.x = camera.position.x;
            minimapCamera.position.z = camera.position.z;
            minimapRenderer.render(scene, minimapCamera);

            // Stats
            actualizarStats();
        }

        animate();

        // ==================== RESIZE ====================
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        setTimeout(() => {
            mostrarMensaje('¬°WASD para moverte! Mouse para rotar üéÆ');
        }, 1000);

    </script>
</body>
</html>